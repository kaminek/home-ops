---
apiVersion: v1
kind: ConfigMap
metadata:
  name: containerd-cleanup-script
  namespace: kube-system
data:
  cleanup.sh: |
    #!/bin/sh
    set -e
    echo "$(date): Starting containerd cleanup"

    # Run crictl on host via nsenter
    nsenter -t 1 -m -u -n -i -- crictl rmi --prune 2>/dev/null || true

    # Clean up exited containers
    nsenter -t 1 -m -u -n -i -- sh -c 'crictl ps -a -q --state exited | xargs -r crictl rm' 2>/dev/null || true

    # Vacuum journald logs
    nsenter -t 1 -m -u -n -i -- journalctl --vacuum-size=100M 2>/dev/null || true

    # Clean old log files
    nsenter -t 1 -m -u -n -i -- find /var/log -name "*.gz" -mtime +3 -delete 2>/dev/null || true
    nsenter -t 1 -m -u -n -i -- find /var/log -name "*.old" -mtime +3 -delete 2>/dev/null || true

    echo "$(date): Cleanup completed"
